@using Umbraco.Cms.Web.Common.PublishedModels
@using Umbraco.Cms.Web.Website.Controllers
@using Umbraco.Cms.Core.Services
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
    Layout = "master.cshtml";
    
    var tasks = Model.Children()
        .Where(x => x.ContentType.Alias == "toDoItem")
        .OrderByDescending(x => x.CreateDate);
}

<h1>@(Model.Value<string>("pageTitle") ?? "To-Do List")</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        @TempData["Success"]
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-error">
        @TempData["Error"]
    </div>
}

<!-- Add New Task Form -->
<div class="add-task-form">
    <h3>Add New Task</h3>
    
    @using (Html.BeginUmbracoForm("Create", "ToDoSurface", FormMethod.Post, new { @class = "task-form" }))
    {
        
        <div>
            <label for="taskTitle">Title: *</label>
            <input type="text" id="taskTitle" name="taskTitle" required />
        </div>
        <div>
            <label for="description">Description:</label>
            <textarea id="description" name="description"></textarea>
        </div>
        <div>
            <label for="dueDate">Due Date:</label>
            <input type="date" id="dueDate" name="dueDate" />
        </div>
        <div>
            <input type="checkbox" id="isCompleted" name="isCompleted" value="true" />
            <label for="isCompleted">Completed</label>
        </div>
        <input type="hidden" name="parentId" value="@Model.Id" />
        <button type="submit">Add Task</button>
    }
</div>

<!-- Tasks List -->
<section class="todo-list">
    @foreach (var task in tasks)
    {
        var completed = task.Value<bool>("isCompleted");
        var taskTitle = task.Value<string>("taskTitle") ?? "Untitled Task";
        var description = task.Value<string>("description") ?? string.Empty;

        <div class="task-item @(completed ? "done" : "")" id="task-@task.Id">
            <strong>@taskTitle</strong>
            
            @if (task.HasValue("dueDate"))
            {
                var dueDate = task.Value<DateTime?>("dueDate");
                if (dueDate.HasValue)
                {
                    <span class="due-date">(Due: @dueDate.Value.ToShortDateString())</span>
                }
            }
            
            <p>@description</p>
            
            <span class="status">
                @(completed ? "✅ Completed" : "⏳ Pending")
            </span>

            <!-- Edit and Delete Buttons -->
            <div class="task-actions">
                <button onclick="toggleEditForm(@task.Id)" class="edit-btn">Edit</button>
                
                @using (Html.BeginUmbracoForm("Delete", "ToDoSurface", FormMethod.Post, new { style = "display: inline;" }))
                {
                    <input type="hidden" name="taskId" value="@task.Id" />
                    <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this task?')">Delete</button>
                }
            </div>

            <!-- Edit Form (Hidden by default) -->
            <div id="edit-form-@task.Id" class="edit-form" style="display: none;">
                <h4>Edit Task</h4>
                
                @using (Html.BeginUmbracoForm("Update", "ToDoSurface", FormMethod.Post, new { @class = "edit-task-form" }))
                {
                    <input type="hidden" name="taskId" value="@task.Id" />
                    <div>
                        <label>Title: *</label>
                        <input type="text" name="taskTitle" value="@taskTitle" required />
                    </div>
                    <div>
                        <label>Description:</label>
                        <textarea name="description">@description</textarea>
                    </div>
                    <div>
                        <label>Due Date:</label>
                        @{
                            var currentDueDate = task.Value<DateTime?>("dueDate");
                        }
                        <input type="date" name="dueDate" value="@(currentDueDate?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <div>
                        <input type="checkbox" name="isCompleted" value="true" @(completed ? "checked" : "") />
                        <label>Completed</label>
                    </div>
                    <button type="submit">Update Task</button>
                    <button type="button" onclick="toggleEditForm(@task.Id)">Cancel</button>
                }
            </div>
        </div>
    }
</section>

<style>
    .todo-list {
        max-width: 600px;
        margin: 20px 0;
    }

    .task-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        background: #f9f9f9;
        position: relative;
    }

    .task-item.done {
        background: #e8f5e8;
        border-color: #4caf50;
        opacity: 0.7;
    }

    .due-date {
        color: #666;
        font-size: 0.9em;
        margin-left: 10px;
    }

    .status {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    .task-item.done .status {
        color: #4caf50;
    }

    .task-item:not(.done) .status {
        color: #ff9800;
    }

    .task-actions {
        margin-top: 10px;
    }

    .edit-btn, .delete-btn {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }

    .edit-btn {
        background: #2196F3;
        color: white;
    }

    .delete-btn {
        background: #f44336;
        color: white;
    }

    .add-task-form, .edit-form {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
    }

    .add-task-form input, .edit-form input,
    .add-task-form textarea, .edit-form textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 3px;
    }

    .alert {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>

<script>
    function toggleEditForm(taskId) {
        const editForm = document.getElementById('edit-form-' + taskId);
        if (editForm.style.display === 'none') {
            editForm.style.display = 'block';
        } else {
            editForm.style.display = 'none';
        }
    }

    // Auto-hide alerts after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                alert.style.display = 'none';
            });
        }, 5000);
    });
</script>